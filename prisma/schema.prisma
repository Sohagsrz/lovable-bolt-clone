generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id              String           @id @default(cuid())
  name            String?
  email           String?          @unique
  password        String?
  avatarUrl       String?
  role            String           @default("user")
  plan            String           @default("free")
  status          String           @default("active")
  usageLimit      Int              @default(100)
  usageCount      Int              @default(0)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  activityLogs    ActivityLog[]
  billingInvoices BillingInvoice[]
  integrations    Integration[]
  notifications   Notification[]
  projects        Project[]
  memberships     ProjectMember[]
  subscriptions   Subscription[]
  usageMetrics    UsageMetric[]
  sessions        UserSession[]
}

model UserSession {
  id           String   @id @default(cuid())
  userId       String
  ipAddress    String?
  userAgent    String?
  lastActiveAt DateTime @default(now())
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id])
}

model Subscription {
  id                 String   @id @default(cuid())
  userId             String
  provider           String?
  plan               String
  status             String
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  createdAt          DateTime @default(now())
  user               User     @relation(fields: [userId], references: [id])
}

model Project {
  id           String                @id @default(cuid())
  userId       String
  name         String
  description  String?
  framework    String                @default("react")
  visibility   String                @default("private")
  status       String                @default("active")
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt
  activityLogs ActivityLog[]
  agents       Agent[]
  chats        Chat[]
  components   Component[]
  deployments  Deployment[]
  envVars      EnvironmentVariable[]
  errorLogs    ErrorLog[]
  previews     Preview[]
  user         User                  @relation(fields: [userId], references: [id])
  files        ProjectFile[]
  members      ProjectMember[]
  versions     ProjectVersion[]
  sandboxes    Sandbox[]
  usageMetrics UsageMetric[]
  workflows    Workflow[]
}

model ProjectMember {
  id        String   @id @default(cuid())
  projectId String
  userId    String
  role      String   @default("editor")
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
  project   Project  @relation(fields: [projectId], references: [id])
}

model ProjectFile {
  id        String   @id @default(cuid())
  projectId String
  path      String
  content   String
  language  String?
  size      Int      @default(0)
  updatedAt DateTime @updatedAt
  project   Project  @relation(fields: [projectId], references: [id])
}

model ProjectVersion {
  id            String   @id @default(cuid())
  projectId     String
  commitMessage String
  createdBy     String
  createdAt     DateTime @default(now())
  project       Project  @relation(fields: [projectId], references: [id])
}

model Agent {
  id        String      @id @default(cuid())
  projectId String
  type      String
  status    String      @default("idle")
  createdAt DateTime    @default(now())
  project   Project     @relation(fields: [projectId], references: [id])
  tasks     AgentTask[]
}

model AgentTask {
  id         String    @id @default(cuid())
  agentId    String
  taskType   String
  input      String?
  output     String?
  status     String    @default("pending")
  startedAt  DateTime?
  finishedAt DateTime?
  agent      Agent     @relation(fields: [agentId], references: [id])
}

model Chat {
  id        String        @id @default(cuid())
  projectId String
  userId    String
  mode      String        @default("build")
  createdAt DateTime      @default(now())
  project   Project       @relation(fields: [projectId], references: [id])
  messages  ChatMessage[]
}

model ChatMessage {
  id        String   @id @default(cuid())
  chatId    String
  role      String
  content   String
  createdAt DateTime @default(now())
  chat      Chat     @relation(fields: [chatId], references: [id])
}

model Sandbox {
  id        String    @id @default(cuid())
  projectId String
  provider  String    @default("stackblitz")
  status    String    @default("stopped")
  url       String?
  startedAt DateTime?
  stoppedAt DateTime?
  project   Project   @relation(fields: [projectId], references: [id])
}

model Preview {
  id        String   @id @default(cuid())
  projectId String
  sandboxId String?
  iframeUrl String?
  device    String   @default("desktop")
  createdAt DateTime @default(now())
  project   Project  @relation(fields: [projectId], references: [id])
}

model Deployment {
  id          String    @id @default(cuid())
  projectId   String
  provider    String
  environment String    @default("production")
  url         String?
  status      String    @default("pending")
  deployedAt  DateTime?
  project     Project   @relation(fields: [projectId], references: [id])
}

model EnvironmentVariable {
  id        String   @id @default(cuid())
  projectId String
  key       String
  value     String
  isSecret  Boolean  @default(false)
  createdAt DateTime @default(now())
  project   Project  @relation(fields: [projectId], references: [id])
}

model Component {
  id        String      @id @default(cuid())
  projectId String
  name      String
  type      String
  props     String?
  createdAt DateTime    @default(now())
  project   Project     @relation(fields: [projectId], references: [id])
  elements  UIElement[]
}

model UIElement {
  id          String    @id @default(cuid())
  componentId String
  tag         String
  attributes  String?
  styles      String?
  createdAt   DateTime  @default(now())
  component   Component @relation(fields: [componentId], references: [id])
}

model Workflow {
  id        String         @id @default(cuid())
  projectId String
  name      String
  status    String         @default("idle")
  createdAt DateTime       @default(now())
  project   Project        @relation(fields: [projectId], references: [id])
  steps     WorkflowStep[]
}

model WorkflowStep {
  id         String   @id @default(cuid())
  workflowId String
  stepType   String
  config     String?
  orderIndex Int
  workflow   Workflow @relation(fields: [workflowId], references: [id])
}

model ActivityLog {
  id        String   @id @default(cuid())
  userId    String?
  projectId String?
  action    String
  metadata  String?
  createdAt DateTime @default(now())
  project   Project? @relation(fields: [projectId], references: [id])
  user      User?    @relation(fields: [userId], references: [id])
}

model Integration {
  id          String   @id @default(cuid())
  userId      String
  provider    String
  accessToken String?
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id])
}

model UsageMetric {
  id         String   @id @default(cuid())
  userId     String?
  projectId  String?
  metricType String
  value      Float
  recordedAt DateTime @default(now())
  project    Project? @relation(fields: [projectId], references: [id])
  user       User?    @relation(fields: [userId], references: [id])
}

model Template {
  id          String         @id @default(cuid())
  name        String
  description String?
  framework   String
  visibility  String         @default("public")
  createdBy   String?
  createdAt   DateTime       @default(now())
  files       TemplateFile[]
}

model TemplateFile {
  id         String   @id @default(cuid())
  templateId String
  path       String
  content    String
  createdAt  DateTime @default(now())
  template   Template @relation(fields: [templateId], references: [id])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  payload   String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model ErrorLog {
  id         String   @id @default(cuid())
  projectId  String
  source     String
  message    String
  stackTrace String?
  createdAt  DateTime @default(now())
  project    Project  @relation(fields: [projectId], references: [id])
}

model BillingInvoice {
  id       String    @id @default(cuid())
  userId   String
  amount   Float
  currency String    @default("USD")
  status   String    @default("pending")
  issuedAt DateTime  @default(now())
  paidAt   DateTime?
  user     User      @relation(fields: [userId], references: [id])
}

model AIModel {
  id           String      @id @default(cuid())
  name         String
  provider     String
  contextLimit Int
  createdAt    DateTime    @default(now())
  requests     AIRequest[]
}

model AIRequest {
  id         String   @id @default(cuid())
  userId     String
  projectId  String?
  modelId    String
  tokensUsed Int
  cost       Float?
  createdAt  DateTime @default(now())
  model      AIModel  @relation(fields: [modelId], references: [id])
}
